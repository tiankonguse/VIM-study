# vim学习笔记之粘贴


## 基本操作


```text
p 粘贴
配置后，可以使用鼠标中键快捷粘贴
```


## 粘贴格式换乱

当我们的vim配置了自动缩进和自动补全括号和引号时,就会发现粘贴的时候,代码比较乱,而且后面多了很多括号和引号.  

这是因为vim不能识别我们发给他的代码,他当做输入流传给编辑器,遇到回车就改自动对齐继续对齐,然后我们的空白在对齐后追加在后面.结果就是没有对齐了.  

### 解决原因

对于这个问题该怎么解决呢?  

我们可以临时取消自动缩进和自动补全,粘贴完之后再启动这些配置就行了.  


```
#粘贴前,设置粘贴模式
:set paste

#这里粘贴

#粘贴后,取消粘贴模式
:set nopaste
```

### 原理解释

当我们设置了粘贴模式时,vim的环境都做了哪些事呢?  

- 屏蔽插入模式和命令行模式的映射
- 屏蔽缩写
- 'textwidth' 设为 0
- 'wrapmargin' 设为 0
- 'autoindent' 被复位
- 'smartindent' 被复位
- 'softtabstop' 设为 0
- 'revins' 被复位
- 'ruler' 被复位
- 'showmatch' 被复位
- 'formatoptions' 的使用方式就像它为空一样
- 'lisp' 失效
- 'indentexpr' 失效
- 'cindent' 失效


### 快捷键

使用上面的开关固然可以解决问题,但是总是敲哪几个命令嫌他麻烦,能不能配置成快捷键呢?  

答案肯定是可以的,关键在于我们怎么配置啦.  


最简单的是两个命令分别配置一个快捷键.  

```
:map <F10> :set paste<CR>
:map <F11> :set nopaste<CR>
```

使用两个快捷键虽然可以解决问题,但是如果可以使用一个快捷键就更好了.  

按一下打开开关,再按一下关闭开关.  

原来 vim 自带这个一个命令的.  

```
set pastetoggle=<F9>
```

这样我们只需要粘贴前按一下 <F9>, 粘贴后再按一下 <F9> 即可。  


有时候，我们感觉这样按 <F9> 也挺麻烦的，如果可以直接按平常的键就完成粘贴复制就好了。  

后来发现还真有这么一个方法。  

```
"+p
```

要解释这个， 就要说说vim粘贴复制的原理了。  


## 粘贴复制原理


我们复制的时候， vim会把内容缓存在寄存器中， 粘贴的时候，从寄存器中取出。  

默认只是用一个寄存器， 即新复制的东西覆盖掉之前寄存器的内容。  

如果我们想保留复制的东西， 就需要给复制的东西打个标签来区分他们。  

标签以双引号开始，跟着的是标签名称，可以是数字0-9，也可以是26个字母，然后就是复制操作，这样就把复制内容保存到该标签寄存器里。  

是用 `:reg` 命令可以查看所有的寄存器内容。  

这里只解释两个寄存器: `"*` 寄存器是系统选择缓冲区， `"+` 寄存器是系统剪切板。  

## 缓冲区和剪切板

Linux系统里存在两个剪切板:一个叫做选择缓冲区(X11 selection buffer)，另一个才是剪切板(clipboard)。  

选择缓冲区是实时的，当使用鼠标或键盘选择内容时，内容已经存在于选择缓冲区了，这或许就是选择缓冲区的由来吧。  

使用下面的命令查看选择缓冲区的内容  

```
xclip -out
```
可以使用鼠标中键或键入Shift+Insert来粘贴选择缓冲区的内容。  
但对于有些GUI程序，比如gedit，只能通过鼠标中键调用选择缓冲区的内容，使用Shift+Insert的话，调用的是剪切板的内容。

剪切板和Windows的剪切板类似，在选择文字内容后，执行Ctrl + c或在菜单里选择复制的话，这时内容才存放到剪切板里。  
使用剪切板的内容，则是Ctrl+v。   
对于gnome-terminal，不能直接使用Ctrl+c，Ctrl+v，这时就要用Shift+Ctrl+c，Shift+Ctrl+v代替。  

## vim中的复制

了解了上面的缓冲区， 就可以理解很多东西了。  
比如 vim 的可视模式。  

可视模式下，选择的内容会被缓存到选择缓冲区中， 我们使用 `"+y` 命令可以将内容保存到剪切板中。  
然后外面的程序就可以使用粘贴复制了。  

### 鼠标模式


最常见的鼠标模式是 `:set mouse=a` 和 `:set mouse=v`.  

`mouse=a` 在普通模式下可以直接使用鼠标选择区域复制到选择缓冲区。但这种情况下不能复制到剪切板。  
`mouse=v` 可以像上面一样直接使用鼠标选择区域复制到选择缓冲区以外，还可以在右键菜单中选择复制来保存到剪切板里。  

但新问题又出来了。若显示行号，也会将行号一并选择。  
你会想到，这好办呀，如果不需要行号的话，在复制前，先执行set nonu来取消行号显示呗。  
但新问题又出来了。若显示行号，也会将行号一并选择。你会想到，这好办呀，如果不需要行号的话，在复制前，先执行set nonu来取消行号显示呗。

其实没必要这样，如果不需要复制行号的话，用在可视模式下用键盘来选择不就可以吗？  

并且，从上面的讨论，我们不难得出，使用选择缓冲区比使用剪切板要方便的多，可以节省很多步骤。  

所以，最终我们得到了vim文件间复制粘贴的完美方案，文件传输的中转使用选择缓冲区。  




## 参考资料

[解决vi/vim中粘贴会在行首多很多缩进和空格的问题][cnblogs-end-2531142]



##links
   * [目录](readme.md)


[jianyungsun-1988855]: http://www.cnblogs.com/jianyungsun/archive/2011/03/19/1988855.html
[cnblogs-end-2531142]: http://www.cnblogs.com/end/archive/2012/06/01/2531142.html
